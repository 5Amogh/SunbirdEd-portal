<!DOCTYPE html>
<html>

<head>
    <title></title>
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.19/js/dataTables.material.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.19/js/dataTables.material.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.7.5/angular.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/material-design-lite/1.1.0/material.min.css"
    />
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.19/css/dataTables.material.min.css" />
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css" />
    <style type="text/css">
        .ui.fluid.container {
            width: 90%;
        }

        .menu {
            margin-top: 10px !important;
        }

        .chartDiv {
            display: block;
            width: 1000px;
            height: 320px;
            margin-bottom: 20px;
        }
    </style>
</head>

<body class="ui fluid container" ng-app="dashboardApp" ng-controller="MainCtrl">
    <div class="ui top attached tabular menu">
        <a id="graph" ng-class="tab == 'graphs' ? 'item active' : 'item'" ng-click="showGraphs()">Graphs</a>
        <a id="datatable" ng-class="tab == 'datatable' ? 'item active' : 'item'" ng-click="showDataTable()">Data Table</a>
        <div class="right menu">
            <a class="ui item" onclick="downloadCSV()">Download CSV</a>
        </div>
    </div>
    <div class="ui bottom attached segment">
        <div id="graphDiv" ng-show="tab == 'graphs'">
            <div class="chartDiv" ng-repeat="chart in charts track by $index">
                <!-- <div ng-if="$index % 2 === 0">
                    <div class="ui medium header">{{chart}}</div>
                    <h1 class="ui header center">Coming soon..</h1>
                </div>
                <div ng-if="$index % 2 !== 0"> -->
                <div class="ui medium header">{{chart}}</div>
                <h2 class="ui center aligned header" style="margin-top: 150px " ng-show="$index > 5">
                    Coming soon....
                </h2>
                <canvas ng-hide="$index > 5" id="{{chart}}" height="300" width="1000"></canvas>

                <!-- </div> -->
            </div>
        </div>
        <div id="datatableDiv" ng-show="tab == 'datatable'">
            <table id="table" class="mdl-data-table" style="width:100%">
                <thead>
                    <tr>
                        <th ng-repeat="key in dataTableKeys">{{key}}</th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>
</body>
<script type="text/javascript">

    function downloadCSV() {
        var state = getURLParam('state');
        window.open(state + '/usage.csv', '_blank');
    }

    function getURLParam(param) {
        // var url = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
        // for (var i = 0; i < url.length; i++) {
        //     var urlparam = url[i].split('=');
        //     if (urlparam[0] == param) {
        //         return urlparam[1];
        //     }
        // }
        return 'andhrapradesh';
    }

    var app = angular.module("dashboardApp", []);
    app.controller('MainCtrl', ['$scope', '$timeout', '$http', '$location', '$window', '$document', '$rootScope', function ($scope, $timeout, $http, $location, $window, $document, $rootScope) {

        console.log('$location.search()', $location.search());
        $scope.tab = 'graphs';
        $scope.dataTableLoaded = false;
        $scope.showGraphs = function () {
            $scope.tab = 'graphs';
        }
        $scope.showDataTable = function () {
            if (!$scope.dataTableLoaded) {
                $('#table').DataTable({
                    "scrollX": true,
                    "ajax": state + '/usage_table.json'
                });
                $scope.dataTableLoaded = true;
            }
            $scope.tab = 'datatable';
        }

        var state = getURLParam('state');

        $.ajax({
            url: state + '/usage.json',
            dataType: 'json'
        }).done(function (res) {
            $scope.$apply(function () {
                $scope.dataTableKeys = res.keys;
                $scope.charts = res.keys.slice(1, res.keys.length);
            });

            $scope.charts.forEach(function (chartId) {
                new Chart(document.getElementById(chartId), {
                    type: 'line',
                    data: {
                        labels: res.data.Date,
                        datasets: [
                            {
                                label: chartId,
                                data: res.data[chartId],
                                fill: false,
                                borderColor: "rgb(0, 0, 0)",
                                lineTension: 0.1
                            }
                        ]
                    },
                    options: { responsive: true }
                });
            })
        });

    }])
</script>

</html>